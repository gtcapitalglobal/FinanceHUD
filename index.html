<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance HUD v1.4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-black min-h-screen">
    <div id="app"></div>
    <canvas id="trendChart" style="display:none;"></canvas>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, deleteDoc, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const APP_VERSION = 'v1.4.0';
        const firebaseConfig = {
            apiKey: "AIzaSyBXLgEt0ERSSnPa2hb34vuruWRPHG-I33A",
            authDomain: "gestao-pessoal-f2a6d.firebaseapp.com",
            projectId: "gestao-pessoal-f2a6d",
            storageBucket: "gestao-pessoal-f2a6d.firebasestorage.app",
            messagingSenderId: "979106570809",
            appId: "1:979106570809:web:4c09f578a99cd25407a3e8"
        };

        const translations = {
            pt: { 
                title: 'FINANCE HUD', 
                login: 'ENTRAR', 
                createAccount: 'CRIAR CONTA', 
                email: 'Email', 
                password: 'Senha', 
                logout: 'Sair', 
                monthlyTotal: 'TOTAL MENSAL', 
                fixedExpenses: 'DESPESAS FIXAS', 
                reserves: 'RESERVAS', 
                accumulated: 'acumulado', 
                paid: 'pago', 
                trend: 'TEND√äNCIA 6 MESES', 
                newExpense: 'NOVA DESPESA', 
                description: 'Descri√ß√£o', 
                amount: 'Valor ($)', 
                dueDay: 'Dia (1-31)', 
                add: 'Adicionar', 
                edit: 'Editar', 
                delete: 'Excluir', 
                pay: 'Pagar', 
                markUsed: 'Marcar Usado', 
                used: 'Usado', 
                fixed: 'Fixa (com vencimento)', 
                reserve: 'Reserva (sem vencimento)', 
                monthly: 'Mensal', 
                quarterly: 'Trimestral', 
                semiannual: 'Semestral', 
                annual: 'Anual', 
                biannual: 'Bianual', 
                fixedList: 'DESPESAS FIXAS', 
                reservesList: 'RESERVAS (Sem Vencimento)', 
                noFixed: 'Nenhuma despesa fixa', 
                day: 'Dia', 
                editExpense: 'EDITAR DESPESA', 
                cancel: 'Cancelar', 
                save: 'Salvar',
                forgotPassword: 'Esqueci minha senha',
                resetPassword: 'RECUPERAR SENHA',
                backToLogin: 'Voltar ao login',
                sendResetEmail: 'Enviar email de recupera√ß√£o',
                loading: 'Carregando...',
                // Mensagens de erro
                errorInvalidCredentials: 'Email ou senha incorretos',
                errorUserNotFound: 'Email n√£o cadastrado',
                errorWeakPassword: 'A senha deve ter pelo menos 6 caracteres',
                errorEmailInUse: 'Este email j√° est√° cadastrado',
                errorInvalidEmail: 'Email inv√°lido',
                errorGeneric: 'Erro ao processar. Tente novamente.',
                errorNetworkFailed: 'Erro de conex√£o. Verifique sua internet.',
                successPasswordReset: 'Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.',
                errorTooManyRequests: 'Muitas tentativas. Aguarde alguns minutos.'
            },
            en: { 
                title: 'FINANCE HUD', 
                login: 'LOGIN', 
                createAccount: 'CREATE ACCOUNT', 
                email: 'Email', 
                password: 'Password', 
                logout: 'Logout', 
                monthlyTotal: 'MONTHLY TOTAL', 
                fixedExpenses: 'FIXED EXPENSES', 
                reserves: 'RESERVES', 
                accumulated: 'accumulated', 
                paid: 'paid', 
                trend: '6-MONTH TREND', 
                newExpense: 'NEW EXPENSE', 
                description: 'Description', 
                amount: 'Amount ($)', 
                dueDay: 'Due day (1-31)', 
                add: 'Add', 
                edit: 'Edit', 
                delete: 'Delete', 
                pay: 'Pay', 
                markUsed: 'Mark Used', 
                used: 'Used', 
                fixed: 'Fixed (with due date)', 
                reserve: 'Reserve (no due date)', 
                monthly: 'Monthly', 
                quarterly: 'Quarterly', 
                semiannual: 'Semiannual', 
                annual: 'Annual', 
                biannual: 'Biannual', 
                fixedList: 'FIXED EXPENSES', 
                reservesList: 'RESERVES (No Due Date)', 
                noFixed: 'No fixed expenses', 
                day: 'Day', 
                editExpense: 'EDIT EXPENSE', 
                cancel: 'Cancel', 
                save: 'Save',
                forgotPassword: 'Forgot password',
                resetPassword: 'RESET PASSWORD',
                backToLogin: 'Back to login',
                sendResetEmail: 'Send reset email',
                loading: 'Loading...',
                // Error messages
                errorInvalidCredentials: 'Invalid email or password',
                errorUserNotFound: 'Email not registered',
                errorWeakPassword: 'Password must be at least 6 characters',
                errorEmailInUse: 'This email is already registered',
                errorInvalidEmail: 'Invalid email',
                errorGeneric: 'Error processing. Please try again.',
                errorNetworkFailed: 'Connection error. Check your internet.',
                successPasswordReset: 'Reset email sent! Check your inbox.',
                errorTooManyRequests: 'Too many attempts. Wait a few minutes.'
            }
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null, expenses = [], customCategories = [], showSettings = false, editingExpense = null, trendChartInstance = null, currentLang = 'pt';
        let isLoading = false, authError = '', showForgotPassword = false;

        const defaultCategories = [
            { value: 'moradia', label: 'üè† Moradia', labelEn: 'üè† Housing', isDefault: true },
            { value: 'cartao', label: 'üí≥ Cart√µes', labelEn: 'üí≥ Cards', isDefault: true },
            { value: 'carro', label: 'üöó Carro', labelEn: 'üöó Car', isDefault: true },
            { value: 'alimentacao', label: 'üçî Alimenta√ß√£o', labelEn: 'üçî Food', isDefault: true },
            { value: 'lazer', label: 'üéÆ Lazer', labelEn: 'üéÆ Leisure', isDefault: true },
            { value: 'saude', label: 'üíä Sa√∫de', labelEn: 'üíä Health', isDefault: true },
            { value: 'outros', label: 'üì¶ Outros', labelEn: 'üì¶ Others', isDefault: true }
        ];

        const t = (key) => translations[currentLang][key] || key;
        const getCategoryLabel = (cat) => cat.isDefault ? (currentLang === 'pt' ? cat.label : cat.labelEn) : cat.label;

        // Fun√ß√£o para traduzir erros do Firebase
        function getErrorMessage(errorCode) {
            const errorMap = {
                'auth/invalid-credential': 'errorInvalidCredentials',
                'auth/user-not-found': 'errorUserNotFound',
                'auth/wrong-password': 'errorInvalidCredentials',
                'auth/weak-password': 'errorWeakPassword',
                'auth/email-already-in-use': 'errorEmailInUse',
                'auth/invalid-email': 'errorInvalidEmail',
                'auth/network-request-failed': 'errorNetworkFailed',
                'auth/too-many-requests': 'errorTooManyRequests'
            };
            return t(errorMap[errorCode] || 'errorGeneric');
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) { loadLanguage(); loadExpenses(); loadCustomCategories(); }
            render();
        });

        async function loadLanguage() {
            const docSnap = await getDoc(doc(db, `users/${currentUser.uid}/settings`, 'preferences'));
            if (docSnap.exists() && docSnap.data().language) currentLang = docSnap.data().language;
        }

        async function saveLanguage(lang) {
            currentLang = lang;
            await setDoc(doc(db, `users/${currentUser.uid}/settings`, 'preferences'), { language: lang }, { merge: true });
            render();
        }

        async function loadExpenses() {
            onSnapshot(query(collection(db, `users/${currentUser.uid}/expenses`)), (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
                updateTrendChart();
            });
        }

        async function loadCustomCategories() {
            const docSnap = await getDoc(doc(db, `users/${currentUser.uid}/settings`, 'categories'));
            if (docSnap.exists()) customCategories = docSnap.data().categories || [];
        }

        function getAllCategories() { return [...defaultCategories, ...customCategories]; }

        async function handleAuth(isLogin) {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            // Limpar erros anteriores
            authError = '';
            emailInput.classList.remove('border-red-500');
            passwordInput.classList.remove('border-red-500');
            
            // Valida√ß√£o b√°sica
            if (!email || !password) {
                authError = t('errorInvalidEmail');
                if (!email) emailInput.classList.add('border-red-500');
                if (!password) passwordInput.classList.add('border-red-500');
                render();
                return;
            }
            
            isLoading = true;
            render();
            
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                authError = '';
            } catch (error) {
                authError = getErrorMessage(error.code);
                emailInput.classList.add('border-red-500');
                passwordInput.classList.add('border-red-500');
            } finally {
                isLoading = false;
                render();
            }
        }

        async function handlePasswordReset() {
            const emailInput = document.getElementById('resetEmail');
            const email = emailInput.value.trim();
            
            authError = '';
            emailInput.classList.remove('border-red-500');
            
            if (!email) {
                authError = t('errorInvalidEmail');
                emailInput.classList.add('border-red-500');
                render();
                return;
            }
            
            isLoading = true;
            render();
            
            try {
                await sendPasswordResetEmail(auth, email);
                authError = '';
                alert(t('successPasswordReset'));
                showForgotPassword = false;
            } catch (error) {
                authError = getErrorMessage(error.code);
                emailInput.classList.add('border-red-500');
            } finally {
                isLoading = false;
                render();
            }
        }

        async function addExpense(e) {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const frequency = document.getElementById('frequency').value;
            const expenseType = document.getElementById('expenseType').value;
            const dueDay = expenseType === 'fixed' ? parseInt(document.getElementById('dueDay').value) : null;
            const divisors = { monthly: 1, quarterly: 3, semiannual: 6, annual: 12, biannual: 24 };
            const monthlyAmount = amount / divisors[frequency];
            await addDoc(collection(db, `users/${currentUser.uid}/expenses`), {
                description, amount, monthlyAmount, category, frequency, expenseType, dueDay,
                paymentHistory: {}, usageHistory: {}, createdAt: new Date().toISOString()
            });
            document.getElementById('expenseForm').reset();
        }

        function startEdit(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) { alert('Not found'); return; }
            editingExpense = { ...expense };
            if (!editingExpense.expenseType) editingExpense.expenseType = 'fixed';
            render();
        }

        function cancelEdit() { editingExpense = null; render(); }

        async function saveEdit(e) {
            e.preventDefault();
            const description = document.getElementById('editDescription').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const category = document.getElementById('editCategory').value;
            const frequency = document.getElementById('editFrequency').value;
            const expenseType = document.getElementById('editExpenseType').value;
            const dueDay = expenseType === 'fixed' ? parseInt(document.getElementById('editDueDay').value) : null;
            const divisors = { monthly: 1, quarterly: 3, semiannual: 6, annual: 12, biannual: 24 };
            const monthlyAmount = amount / divisors[frequency];
            await updateDoc(doc(db, `users/${currentUser.uid}/expenses/${editingExpense.id}`), {
                description, amount, monthlyAmount, category, frequency, expenseType, dueDay
            });
            editingExpense = null;
            render();
        }

        async function togglePaid(expenseId, month, year) {
            const expense = expenses.find(e => e.id === expenseId);
            const key = `${year}-${month}`;
            await updateDoc(doc(db, `users/${currentUser.uid}/expenses/${expenseId}`), {
                paymentHistory: { ...expense.paymentHistory, [key]: !expense.paymentHistory[key] }
            });
        }

        async function toggleUsed(expenseId, month, year) {
            const expense = expenses.find(e => e.id === expenseId);
            const key = `${year}-${month}`;
            await updateDoc(doc(db, `users/${currentUser.uid}/expenses/${expenseId}`), {
                usageHistory: { ...expense.usageHistory, [key]: !expense.usageHistory[key] }
            });
        }

        async function deleteExpense(expenseId) {
            if (confirm(t('delete') + '?')) await deleteDoc(doc(db, `users/${currentUser.uid}/expenses/${expenseId}`));
        }

        function updateTrendChart() {
            if (!currentUser || expenses.length === 0) return;
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            const now = new Date();
            const last6Months = [], monthlyTotals = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                last6Months.push(date.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'en-US', { month: 'short', year: 'numeric' }));
                const total = expenses.reduce((sum, exp) => sum + (exp.monthlyAmount || exp.amount), 0);
                monthlyTotals.push(total.toFixed(2));
            }
            if (trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: last6Months,
                    datasets: [{ label: t('monthlyTotal'), data: monthlyTotals, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.1)', tension: 0.4, fill: true }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => '$' + v, color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });
        }

        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                if (showForgotPassword) {
                    // Tela de recupera√ß√£o de senha
                    app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4 text-white">
                        <div class="max-w-md w-full bg-black/40 backdrop-blur-md border-2 border-purple-500/30 rounded-xl p-6">
                            <h1 class="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">${t('resetPassword')}</h1>
                            <p class="text-center text-xs text-gray-500 mb-6">${APP_VERSION}</p>
                            ${authError ? `<div class="mb-4 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-200 text-sm">${authError}</div>` : ''}
                            <div class="space-y-4">
                                <input type="email" id="resetEmail" placeholder="${t('email')}" 
                                    class="w-full bg-black/50 border-2 border-purple-500/50 rounded-lg px-4 py-3 text-white focus:border-purple-400 focus:outline-none transition-colors">
                                <button onclick="handlePasswordReset()" 
                                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                                    ${isLoading ? 'disabled' : ''}>
                                    ${isLoading ? t('loading') : 'üìß ' + t('sendResetEmail')}
                                </button>
                                <button onclick="toggleForgotPassword()" 
                                    class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg transition-colors">
                                    ‚Üê ${t('backToLogin')}
                                </button>
                            </div>
                        </div>
                    </div>`;
                } else {
                    // Tela de login
                    app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4 text-white">
                        <div class="max-w-md w-full bg-black/40 backdrop-blur-md border-2 border-purple-500/30 rounded-xl p-6">
                            <h1 class="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">${t('title')}</h1>
                            <p class="text-center text-xs text-gray-500 mb-6">${APP_VERSION}</p>
                            ${authError ? `<div class="mb-4 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-200 text-sm">‚ö†Ô∏è ${authError}</div>` : ''}
                            <div class="space-y-4">
                                <input type="email" id="email" placeholder="${t('email')}" 
                                    class="w-full bg-black/50 border-2 border-purple-500/50 rounded-lg px-4 py-3 text-white focus:border-purple-400 focus:outline-none transition-colors">
                                <input type="password" id="password" placeholder="${t('password')}" 
                                    class="w-full bg-black/50 border-2 border-purple-500/50 rounded-lg px-4 py-3 text-white focus:border-purple-400 focus:outline-none transition-colors">
                                <button onclick="handleAuth(true)" 
                                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                                    ${isLoading ? 'disabled' : ''}>
                                    ${isLoading ? '‚è≥ ' + t('loading') : 'üîê ' + t('login')}
                                </button>
                                <button onclick="handleAuth(false)" 
                                    class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                                    ${isLoading ? 'disabled' : ''}>
                                    ${isLoading ? '‚è≥ ' + t('loading') : '‚ú® ' + t('createAccount')}
                                </button>
                                <button onclick="toggleForgotPassword()" 
                                    class="w-full text-purple-300 hover:text-purple-200 text-sm underline transition-colors">
                                    üîë ${t('forgotPassword')}
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
                return;
            }
            const now = new Date(), currentMonth = now.getMonth(), currentYear = now.getFullYear();
            const fixedExpenses = expenses.filter(exp => exp.expenseType === 'fixed' || !exp.expenseType).map(exp => ({ ...exp, isPaid: exp.paymentHistory?.[`${currentYear}-${currentMonth}`] || false, displayAmount: exp.monthlyAmount || exp.amount }));
            const reserves = expenses.filter(exp => exp.expenseType === 'reserve').map(exp => ({ ...exp, isUsed: exp.usageHistory?.[`${currentYear}-${currentMonth}`] || false, displayAmount: exp.monthlyAmount || exp.amount, accumulated: exp.displayAmount }));
            const fixedTotal = fixedExpenses.reduce((sum, exp) => sum + exp.displayAmount, 0);
            const reserveTotal = reserves.reduce((sum, exp) => sum + exp.displayAmount, 0);
            const monthTotal = fixedTotal + reserveTotal;
            const paidCount = fixedExpenses.filter(e => e.isPaid).length;
            const allCategories = getAllCategories();

            app.innerHTML = `<div class="min-h-screen text-white p-4"><div class="max-w-7xl mx-auto"><div class="bg-black/40 backdrop-blur-md border-2 border-purple-500/30 rounded-xl p-4 mb-4 flex justify-between items-center"><div><h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">${t('title')}</h1><p class="text-xs text-gray-500">${APP_VERSION}</p></div><div class="flex gap-2"><button onclick="toggleLang()" class="px-4 py-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/50 rounded-lg text-sm">${currentLang === 'pt' ? 'üáßüá∑ PT' : 'üá∫üá∏ EN'}</button><button onclick="handleLogout()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm">${t('logout')}</button></div></div>
            <div class="grid md:grid-cols-3 gap-4 mb-4"><div class="bg-black/60 border-2 border-purple-500/30 rounded-xl p-6"><h3 class="text-sm text-purple-300 font-semibold mb-2">${t('monthlyTotal')}</h3><p class="text-4xl font-bold text-purple-400">$${monthTotal.toFixed(2)}</p></div><div class="bg-black/60 border-2 border-blue-500/30 rounded-xl p-6"><h3 class="text-sm text-blue-300 font-semibold mb-2">${t('fixedExpenses')}</h3><p class="text-4xl font-bold text-blue-400">${paidCount}/${fixedExpenses.length}</p></div><div class="bg-black/60 border-2 border-green-500/30 rounded-xl p-6"><h3 class="text-sm text-green-300 font-semibold mb-2">${t('reserves')}</h3><p class="text-4xl font-bold text-green-400">${reserves.length}</p></div></div>
            ${expenses.length > 0 ? `<div class="bg-black/60 border-2 border-purple-500/30 rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">üìà ${t('trend')}</h2><div style="height:200px;"><canvas id="trendChart"></canvas></div></div>` : ''}
            ${!editingExpense ? `<div class="bg-black/60 border-2 border-purple-500/30 rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">‚ûï ${t('newExpense')}</h2><form id="expenseForm" onsubmit="addExpense(event)" class="space-y-3"><input type="text" id="description" placeholder="${t('description')}" required class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white"><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><input type="number" id="amount" placeholder="${t('amount')}" step="0.01" required class="bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white"><select id="frequency" class="bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white"><option value="monthly">${t('monthly')}</option><option value="quarterly">${t('quarterly')}</option><option value="semiannual">${t('semiannual')}</option><option value="annual">${t('annual')}</option><option value="biannual">${t('biannual')}</option></select><select id="category" class="bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white">${allCategories.map(cat => `<option value="${cat.value}">${getCategoryLabel(cat)}</option>`).join('')}</select><select id="expenseType" onchange="toggleDueDay()" class="bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white"><option value="fixed">üìÖ ${t('fixed')}</option><option value="reserve">üí∞ ${t('reserve')}</option></select></div><div id="dueDayContainer"><input type="number" id="dueDay" placeholder="${t('dueDay')}" min="1" max="31" required class="w-full bg-black/50 border border-purple-500/50 rounded-lg px-4 py-2 text-white"></div><button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg">‚úÖ ${t('add')}</button></form></div>` : `<div class="bg-black/60 border-2 border-yellow-500/30 rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">‚úèÔ∏è ${t('editExpense')}</h2><form onsubmit="saveEdit(event)" class="space-y-3"><input type="text" id="editDescription" value="${editingExpense.description}" required class="w-full bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white"><div class="grid grid-cols-2 gap-3"><input type="number" id="editAmount" value="${editingExpense.amount}" step="0.01" required class="bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white"><select id="editFrequency" class="bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white"><option value="monthly" ${editingExpense.frequency === 'monthly' ? 'selected' : ''}>${t('monthly')}</option><option value="quarterly" ${editingExpense.frequency === 'quarterly' ? 'selected' : ''}>${t('quarterly')}</option><option value="semiannual" ${editingExpense.frequency === 'semiannual' ? 'selected' : ''}>${t('semiannual')}</option><option value="annual" ${editingExpense.frequency === 'annual' ? 'selected' : ''}>${t('annual')}</option><option value="biannual" ${editingExpense.frequency === 'biannual' ? 'selected' : ''}>${t('biannual')}</option></select></div><div class="grid grid-cols-2 gap-3"><select id="editCategory" class="bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white">${allCategories.map(cat => `<option value="${cat.value}" ${editingExpense.category === cat.value ? 'selected' : ''}>${getCategoryLabel(cat)}</option>`).join('')}</select><select id="editExpenseType" onchange="toggleDueDayEdit()" class="bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white"><option value="fixed" ${editingExpense.expenseType === 'fixed' ? 'selected' : ''}>üìÖ ${t('fixed')}</option><option value="reserve" ${editingExpense.expenseType === 'reserve' ? 'selected' : ''}>üí∞ ${t('reserve')}</option></select></div><div id="editDueDayContainer" ${editingExpense.expenseType === 'reserve' ? 'style="display:none;"' : ''}><input type="number" id="editDueDay" value="${editingExpense.dueDay || 1}" min="1" max="31" class="w-full bg-black/50 border border-yellow-500/50 rounded-lg px-4 py-2 text-white"></div><div class="grid grid-cols-2 gap-3"><button type="button" onclick="cancelEdit()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg">‚ùå ${t('cancel')}</button><button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg">üíæ ${t('save')}</button></div></form></div>`}
            <div class="bg-black/60 border-2 border-purple-500/30 rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">üìÖ ${t('fixedList')}</h2><div class="space-y-2">${fixedExpenses.length === 0 ? `<p class="text-center text-gray-400 py-8">${t('noFixed')}</p>` : fixedExpenses.map(exp => {
                const cat = allCategories.find(c => c.value === exp.category) || { label: 'üì¶ Other' };
                return `<div class="p-4 rounded-lg border-2 ${exp.isPaid ? 'bg-green-500/10 border-green-500/30' : 'bg-white/5 border-purple-500/30'}"><div class="flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span>${getCategoryLabel(cat)}</span><span class="text-xs px-2 py-1 bg-blue-500/20 rounded">${t(exp.frequency || 'monthly')}</span><span class="text-xs px-2 py-1 bg-purple-500/20 rounded">${t('day')} ${exp.dueDay}</span></div><p class="font-semibold text-white mb-1">${exp.description}</p><p class="text-2xl font-bold text-purple-400">$${exp.displayAmount.toFixed(2)}/mo</p></div><div class="flex gap-2 flex-col"><button onclick="togglePaid('${exp.id}', ${currentMonth}, ${currentYear})" class="${exp.isPaid ? 'bg-green-600' : 'bg-gray-600'} text-white px-3 py-1 rounded text-sm">${exp.isPaid ? '‚úì' : t('pay')}</button><button onclick="startEdit('${exp.id}')" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm">‚úèÔ∏è</button><button onclick="deleteExpense('${exp.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">üóëÔ∏è</button></div></div></div>`;
            }).join('')}</div></div>
            ${reserves.length > 0 ? `<div class="bg-black/60 border-2 border-green-500/30 rounded-xl p-6"><h2 class="text-xl font-bold mb-4">üí∞ ${t('reservesList')}</h2><div class="space-y-2">${reserves.map(exp => {
                const cat = allCategories.find(c => c.value === exp.category) || { label: 'üì¶ Other' };
                return `<div class="p-4 rounded-lg border-2 ${exp.isUsed ? 'bg-blue-500/10 border-blue-500/30' : 'bg-green-500/10 border-green-500/30'}"><div class="flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span>${getCategoryLabel(cat)}</span><span class="text-xs px-2 py-1 bg-green-500/20 rounded">${t(exp.frequency || 'monthly')}</span></div><p class="font-semibold text-white mb-1">${exp.description}</p><p class="text-2xl font-bold text-green-400">$${exp.displayAmount.toFixed(2)}/mo</p><p class="text-sm text-green-300 mt-1">üí∞ ${t('accumulated')}: $${exp.accumulated.toFixed(2)}</p></div><div class="flex gap-2 flex-col"><button onclick="toggleUsed('${exp.id}', ${currentMonth}, ${currentYear})" class="${exp.isUsed ? 'bg-blue-600' : 'bg-gray-600'} text-white px-3 py-1 rounded text-sm">${exp.isUsed ? '‚úì ' + t('used') : t('markUsed')}</button><button onclick="startEdit('${exp.id}')" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm">‚úèÔ∏è</button><button onclick="deleteExpense('${exp.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">üóëÔ∏è</button></div></div></div>`;
            }).join('')}</div></div>` : ''}
            <div class="text-center text-gray-500 text-xs py-4 mt-4"><p>Finance HUD ${APP_VERSION} | ${currentLang === 'pt' ? '‚ú® Novo: Recupera√ß√£o de senha + Valida√ß√£o' : '‚ú® New: Password Reset + Validation'}</p></div></div></div>`;
            setTimeout(() => { if (expenses.length > 0) updateTrendChart(); }, 100);
        }

        function toggleDueDay() {
            const type = document.getElementById('expenseType').value;
            const container = document.getElementById('dueDayContainer');
            const input = document.getElementById('dueDay');
            if (type === 'reserve') { container.style.display = 'none'; input.required = false; }
            else { container.style.display = 'block'; input.required = true; }
        }

        function toggleDueDayEdit() {
            const type = document.getElementById('editExpenseType').value;
            const container = document.getElementById('editDueDayContainer');
            const input = document.getElementById('editDueDay');
            if (type === 'reserve') { container.style.display = 'none'; input.required = false; }
            else { container.style.display = 'block'; input.required = true; }
        }

        function toggleLang() { saveLanguage(currentLang === 'pt' ? 'en' : 'pt'); }
        
        function toggleForgotPassword() {
            showForgotPassword = !showForgotPassword;
            authError = '';
            render();
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                alert('Erro ao sair: ' + error.message);
            }
        }

        window.handleAuth = handleAuth;
        window.handlePasswordReset = handlePasswordReset;
        window.handleLogout = handleLogout;
        window.addExpense = addExpense;
        window.togglePaid = togglePaid;
        window.toggleUsed = toggleUsed;
        window.deleteExpense = deleteExpense;
        window.toggleLang = toggleLang;
        window.toggleForgotPassword = toggleForgotPassword;
        window.startEdit = startEdit;
        window.cancelEdit = cancelEdit;
        window.saveEdit = saveEdit;
        window.toggleDueDay = toggleDueDay;
        window.toggleDueDayEdit = toggleDueDayEdit;
        render();
    </script>
</body>
</html>
